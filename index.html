<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D20 Multi-Core Streak Hunter (Turbo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #000;
      color: #0f0;
      font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    #stats {
      margin-top: 12px;
      white-space: pre-line;
      font-size: 0.95rem;
      line-height: 1.5;
    }
    button {
      margin-top: 20px;
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid #0f0;
      background: #020;
      color: #0f0;
      font-size: 1rem;
      cursor: pointer;
    }
    button:active { background: #040; }
  </style>
</head>
<body>

<h1>D20 Multi-Core Streak Hunter (Turbo)</h1>
<div id="stats">Ready.</div>
<button id="startBtn">Start Rolling</button>

<script>
///////////////////////////////////////////////////////////////////////////////
// CONFIG
///////////////////////////////////////////////////////////////////////////////

// Target streak (10 twenties in a row)
const TARGET_STREAK = 10;

// Number of workers (CPU cores). Try 2â€“4 on an older laptop.
// 4 = more speed but more heat / more chance for browser to throttle.
const WORKERS = 4;

// How often to update UI (ms)
const UPDATE_MS = 1000;

///////////////////////////////////////////////////////////////////////////////
// STATE
///////////////////////////////////////////////////////////////////////////////
let workers = [];
let running = false;

let totalRolls = 0;
let bestStreak = 0;

let lastRolls = 0;
let lastUpdate = 0;

const statsDiv = document.getElementById("stats");
const startBtn = document.getElementById("startBtn");

///////////////////////////////////////////////////////////////////////////////
// WORKER SETUP
///////////////////////////////////////////////////////////////////////////////
function setupWorkers() {
  // Kill any previous workers
  for (const w of workers) {
    try { w.terminate(); } catch (e) {}
  }
  workers = [];

  for (let i = 0; i < WORKERS; i++) {
    const w = new Worker("worker.js");

    w.onmessage = (e) => {
      const msg = e.data;

      if (msg.type === "progress") {
        totalRolls += msg.totalDelta;
        if (msg.bestStreak > bestStreak) {
          bestStreak = msg.bestStreak;
        }
        return;
      }

      if (msg.type === "hit") {
        totalRolls += msg.totalDelta;
        if (msg.bestStreak > bestStreak) {
          bestStreak = msg.bestStreak;
        }

        if (running) {
          running = false;
          // Stop all workers
          for (const other of workers) {
            try { other.postMessage({ type: "stop" }); } catch (e) {}
          }

          alert(
            "ðŸŽ‰ HIT " + TARGET_STREAK + " twenties in a row!\n" +
            "Total rolls (approx): " + totalRolls + "\n" +
            "Best streak: " + bestStreak
          );

          updateStats(performance.now());
          startBtn.disabled = false;
          startBtn.textContent = "Start Again";
        }
      }
    };

    workers.push(w);
  }
}

///////////////////////////////////////////////////////////////////////////////
// UI STATS
///////////////////////////////////////////////////////////////////////////////
function updateStats(now) {
  const dt = (now - lastUpdate) / 1000;
  if (dt <= 0) return;

  const deltaRolls = totalRolls - lastRolls;
  const rps = deltaRolls / dt;

  lastRolls = totalRolls;
  lastUpdate = now;

  statsDiv.textContent =
    "Total rolls: " + totalRolls + "\n" +
    "Speed: " + Math.round(rps) + " rolls/sec\n" +
    "Best streak: " + bestStreak + "\n" +
    "(Workers: " + WORKERS + ")";
}

///////////////////////////////////////////////////////////////////////////////
// MAIN LOOP
///////////////////////////////////////////////////////////////////////////////
function startRolling() {
  if (running) return;

  setupWorkers();

  totalRolls = 0;
  bestStreak = 0;
  lastRolls = 0;
  lastUpdate = performance.now();
  running = true;

  startBtn.disabled = true;
  startBtn.textContent = "Runningâ€¦";

  // Start all workers
  for (const w of workers) {
    w.postMessage({ type: "start" });
  }

  // UI loop â€“ light so browser doesn't freak out
  (function loop() {
    if (!running) return;
    const now = performance.now();
    if (now - lastUpdate >= UPDATE_MS) {
      updateStats(now);
    }
    requestAnimationFrame(loop);
  })();
}

startBtn.addEventListener("click", startRolling);
</script>
</body>
</html>
