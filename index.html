<div id="stats"></div>
<div id="hist"></div>
<div id="chance"></div>
<button id="startBtn">Start</button>

<script>
const WORKERS = 16;   // keep your fast iPad setting
let workers = [];
let running = false;

let totalRolls = 0;
let bestStreak = 0;

// streak histogram (for 1â€“10)
const streakHist = Array(11).fill(0);

function chance10(rolls) {
  // probability at least one 10-streak occurs
  const p = 1 / (20 ** 10);
  return 1 - Math.pow(1 - p, rolls);
}

function setupWorkers() {
  workers.forEach(w => w.terminate());
  workers = [];

  for (let i = 0; i < WORKERS; i++) {
    const w = new Worker("worker.js");
    w.onmessage = (e) => {
      const msg = e.data;

      if (msg.type === "progress") {
        totalRolls += msg.rolls;
        if (msg.best > bestStreak) bestStreak = msg.best;
      }

      if (msg.type === "streak") {
        const s = msg.value;
        if (s >= 1 && s <= 10) streakHist[s]++;
        if (s > 10) streakHist[10]++;
      }

      if (msg.type === "hit10") {
        totalRolls += msg.rolls;
        if (msg.best > bestStreak) bestStreak = msg.best;

        alert("Hit 10 in a row!\nTotal rolls: " + totalRolls);
        running = false;
        workers.forEach(w => w.postMessage("stop"));
      }
    };
    workers.push(w);
  }
}

document.getElementById("startBtn").onclick = () => {
  if (running) return;

  setupWorkers();
  totalRolls = 0;
  bestStreak = 0;
  streakHist.fill(0);

  workers.forEach(w => w.postMessage("start"));
  running = true;

  function loop() {
    if (!running) return;

    document.getElementById("stats").textContent =
      `Rolls: ${totalRolls}\nBest Streak: ${bestStreak}`;

    document.getElementById("hist").textContent =
      streakHist.map((v,i)=> i>0?`${i}: ${v}`:"").join("\n");

    const ch = chance10(totalRolls);
    document.getElementById("chance").textContent =
      `Chance of 10 streak so far: ${(ch*100).toFixed(8)}%`;

    setTimeout(loop, 1000);
  }
  loop();
};
</script>
