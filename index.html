<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>D20 Multi-Core Streak Hunter</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  html, body {
    margin: 0;
    padding: 0;
    background: #000;
    color: #0f0;
    font-family: -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    text-align: center;
  }

  #stats {
    margin-top: 12px;
    white-space: pre-line;
    font-size: 0.95rem;
    line-height: 1.5;
  }

  button {
    margin-top: 20px;
    padding: 10px 16px;
    border-radius: 8px;
    border: 1px solid #0f0;
    background: #020;
    color: #0f0;
    font-size: 1rem;
    cursor: pointer;
  }

  button:active {
    background: #040;
  }
</style>

</head>
<body>

<h1>D20 Multi-Core Streak Hunter</h1>
<div id="stats">Ready.</div>
<button id="startBtn">Start Rolling</button>

<script>
///////////////////////////////////////////////////////////////////////////////
// CONFIG
///////////////////////////////////////////////////////////////////////////////
const TARGET_STREAK = 10;
const WORKERS = 6;    // Increase to 6â€“8 if laptop can handle heat
const UPDATE_MS = 1000;

///////////////////////////////////////////////////////////////////////////////
// STATE
///////////////////////////////////////////////////////////////////////////////
let workers = [];
let running = false;

let totalRolls = 0;
let bestStreak = 0;
let lastRolls = 0;
let lastUpdate = 0;

const histogram = {
  1: 0, 2: 0, 3: 0, 4: 0, 5: 0,
  6: 0, 7: 0, 8: 0, 9: 0, 10: 0
};

const statsDiv = document.getElementById("stats");
const startBtn = document.getElementById("startBtn");

///////////////////////////////////////////////////////////////////////////////
// SETUP WORKERS
///////////////////////////////////////////////////////////////////////////////
function setupWorkers() {
  workers.forEach(w => w.terminate());
  workers = [];

  for (let i = 0; i < WORKERS; i++) {
    const w = new Worker("worker.js");

    w.onmessage = (e) => {
      const msg = e.data;

      if (msg.type === "streak") {
        histogram[msg.value]++;
        return;
      }

      if (msg.type === "progress") {
        totalRolls += msg.totalDelta;
        if (msg.bestStreak > bestStreak) bestStreak = msg.bestStreak;
        return;
      }

      if (msg.type === "hit") {
        totalRolls += msg.totalDelta;
        if (msg.bestStreak > bestStreak) bestStreak = msg.bestStreak;

        running = false;
        workers.forEach(w2 => w2.postMessage({ type: "stop" }));

        alert(
          `ðŸŽ‰ HIT ${TARGET_STREAK} twenties in a row!\n` +
          `Total rolls: ${totalRolls.toLocaleString()}\n` +
          `Best streak: ${bestStreak}`
        );

        updateStats(performance.now());
        startBtn.disabled = false;
        startBtn.textContent = "Start Again";
      }
    };

    workers.push(w);
  }
}

///////////////////////////////////////////////////////////////////////////////
// UPDATE STATS UI
///////////////////////////////////////////////////////////////////////////////
function updateStats(now) {
  const dt = (now - lastUpdate) / 1000;
  if (dt <= 0) return;

  const deltaRolls = totalRolls - lastRolls;
  const rps = deltaRolls / dt;

  lastRolls = totalRolls;
  lastUpdate = now;

  // Chance meter
  const p = 1 / 20;
  const p10 = Math.pow(p, 10);
  const chanceSeen = 1 - Math.pow(1 - p10, totalRolls);
  const percent = (chanceSeen * 100).toFixed(6);

  statsDiv.textContent =
    `Total rolls: ${totalRolls.toLocaleString()}\n` +
    `Speed: ${Math.round(rps).toLocaleString()} rolls/sec\n` +
    `Best streak: ${bestStreak}\n` +
    `Chance we should have seen a 10-streak: ${percent}%\n\n` +
    `Streak Histogram:\n` +
    `1: ${histogram[1]}   2: ${histogram[2]}   3: ${histogram[3]}\n` +
    `4: ${histogram[4]}   5: ${histogram[5]}   6: ${histogram[6]}\n` +
    `7: ${histogram[7]}   8: ${histogram[8]}   9: ${histogram[9]}\n` +
    `10: ${histogram[10]}`;
}

///////////////////////////////////////////////////////////////////////////////
// MAIN LOOP
///////////////////////////////////////////////////////////////////////////////
function startRolling() {
  if (running) return;

  setupWorkers();

  // Reset state
  totalRolls = 0;
  bestStreak = 0;
  lastRolls = 0;
  lastUpdate = performance.now();

  for (let k in histogram) histogram[k] = 0;

  running = true;

  startBtn.disabled = true;
  startBtn.textContent = "Runningâ€¦";

  workers.forEach(w => w.postMessage({ type: "start" }));

  (function loop() {
    if (!running) return;
    const now = performance.now();
    if (now - lastUpdate >= UPDATE_MS) {
      updateStats(now);
    }
    requestAnimationFrame(loop);
  })();
}

startBtn.addEventListener("click", startRolling);
</script>
</body>
</html>
